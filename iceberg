#! /usr/bin/php
<?php

define("ICEBERG_LOG", "iceberg.log");
define("ICEBERG_CONFIG", "config.ini");
define("ICEBERG_HOOK", "hooks.json");

include __DIR__."/lib/twig/Autoloader.php";
include __DIR__."/lib/iceberg/Autoloader.php";
include __DIR__."/lib/iceberg/ErrorHandler.php";

use iceberg\Autoloader;
use iceberg\ErrorHandler;

use iceberg\hook\Hook;
use iceberg\cmd\Command;
use iceberg\config\Config;
use iceberg\shell\ArgumentParser;

if (!ini_get("date.timezone")) {
	date_default_timezone_set("Europe/Berlin");
}

ErrorHandler::register(ICEBERG_LOG);

Twig_Autoloader::register();

Autoloader::register();
Autoloader::addNamespace("iceberg", "lib/iceberg");
Autoloader::addNamespace("commands", "lib");

$args = ArgumentParser::getInstance();

Config::loadFromFile(
	$args->config_val ? $args->config_val : ICEBERG_CONFIG
);

date_default_timezone_set(
	Config::getVal("general", "timezone", true)
);

Hook::loadFromFile(ICEBERG_HOOK);
if ($args->no_hook && !$args->no_hook_val) {
	Hook::disableSystem();
} else if ($args->no_hook) {
	$hooks = explode(",", $args->no_hook_val);
	foreach ($hooks as $hook) {
		Hook::disableHook($hook);
	}
}

Command::setNamespace("commands\{command}");
if (substr($argv[1], 0, 2) != "--") {
	Command::call($argv[1]);
}
